{"title":"DFMB-preprocessing","uid":"54f39c547c269df1bc57406b3c3efac2","slug":"DFMB-preprocessing","date":"2025-11-04T16:00:00.000Z","updated":"2025-11-04T14:19:35.670Z","comments":true,"path":"api/articles/DFMB-preprocessing.json","keywords":null,"cover":[],"content":"<p>​\t这是一个蛋白质相互作用网络(PPI)的图数据处理脚本，它通过加载稀疏矩阵格式的PPI网络数据，为每个蛋白质节点保留权重最高的前top个连接边，添加自环并进行对称归一化处理，最终构建成有向的DGL图格式并保存，用于后续图神经网络模型的训练和预测。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> click</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> scipy.sparse <span class=\"keyword\">as</span> ssp</span><br><span class=\"line\"><span class=\"keyword\">import</span> networkx <span class=\"keyword\">as</span> nx</span><br><span class=\"line\"><span class=\"keyword\">import</span> dgl</span><br><span class=\"line\"><span class=\"keyword\">import</span> dgl.data</span><br><span class=\"line\"><span class=\"keyword\">from</span> tqdm <span class=\"keyword\">import</span> tqdm, trange</span><br><span class=\"line\"><span class=\"keyword\">from</span> logzero <span class=\"keyword\">import</span> logger</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#此时传进来的是稀疏矩阵</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get_norm_net_mat</span>(<span class=\"params\">net_mat</span>):</span><br><span class=\"line\">    degree_0 = np.asarray(net_mat.<span class=\"built_in\">sum</span>(<span class=\"number\">0</span>)).squeeze()<span class=\"comment\">#统计出度,将结果转换为1维数组</span></span><br><span class=\"line\">    mat_d_0 = ssp.diags(degree_0 ** -<span class=\"number\">0.5</span>, <span class=\"built_in\">format</span>=<span class=\"string\">&#x27;csr&#x27;</span>)<span class=\"comment\">#对每个度值求 -1/2 次方,创建稀疏对角矩阵</span></span><br><span class=\"line\">    degree_1 = np.asarray(net_mat.<span class=\"built_in\">sum</span>(<span class=\"number\">1</span>)).squeeze()<span class=\"comment\">#统计入度,将结果转换为1维数组</span></span><br><span class=\"line\">    mat_d_1 = ssp.diags(degree_1 ** -<span class=\"number\">0.5</span>, <span class=\"built_in\">format</span>=<span class=\"string\">&#x27;csr&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> mat_d_0 @ net_mat @ mat_d_1</span><br></pre></td></tr></table></figure>\n\n<p>net_mat的格式可能是<img src=\"https://cdn.jsdelivr.net/gh/12eda/Pictures@main/image-20251104175032084.png\" alt=\"image-20251104175032084\">，随后的操作会得到两个对角矩阵，分明是入度和出度的归一化矩阵<img src=\"https://cdn.jsdelivr.net/gh/12eda/Pictures@main/image-20251104175148133.png\" alt=\"image-20251104175148133\">随后进行矩阵乘法运算，得到了<strong>归一化后的邻接矩阵</strong><img src=\"https://cdn.jsdelivr.net/gh/12eda/Pictures@main/image-20251104175239724.png\" alt=\"image-20251104175239724\">，这样可以使得所有边的权重被重新缩放，防止高度数节点在消息传递中占据主导地位，使矩阵更平衡。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>(<span class=\"params\">ppi_net_mat_path, dgl_graph_path, top</span>):</span><br><span class=\"line\">    mat_ = ssp.load_npz(ppi_net_mat_path)<span class=\"comment\"># 加载原始数据，返回一个稀疏矩阵对象</span></span><br><span class=\"line\">    ppi_net_mat = mat_ + ssp.eye(mat_.shape[<span class=\"number\">0</span>], <span class=\"built_in\">format</span>=<span class=\"string\">&#x27;csr&#x27;</span>)<span class=\"comment\">#添加自环</span></span><br><span class=\"line\">    logger.info(<span class=\"string\">F&#x27;<span class=\"subst\">&#123;ppi_net_mat.shape&#125;</span> <span class=\"subst\">&#123;ppi_net_mat.nnz&#125;</span>&#x27;</span>)<span class=\"comment\">#记录矩阵的基本信息，输出矩阵的维度和非零元素个数</span></span><br><span class=\"line\">    r, c, v = [], [], []<span class=\"comment\"># 分别存储行索引、列索引、权重值</span></span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n\n<p>假设有3个蛋白质，<code>top=2</code>：</p>\n<h3 id=\"原始PPI网络：\"><a href=\"#原始PPI网络：\" class=\"headerlink\" title=\"原始PPI网络：\"></a>原始PPI网络：</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">节点<span class=\"number\">0</span>: [<span class=\"number\">1</span>:<span class=\"number\">0.9</span>, <span class=\"number\">2</span>:<span class=\"number\">0.8</span>, <span class=\"number\">3</span>:<span class=\"number\">0.7</span>]  <span class=\"comment\"># 3个连接</span></span><br><span class=\"line\">节点<span class=\"number\">1</span>: [<span class=\"number\">0</span>:<span class=\"number\">0.9</span>, <span class=\"number\">2</span>:<span class=\"number\">0.5</span>, <span class=\"number\">4</span>:<span class=\"number\">0.4</span>]  <span class=\"comment\"># 3个连接  </span></span><br><span class=\"line\">节点<span class=\"number\">2</span>: [<span class=\"number\">0</span>:<span class=\"number\">0.8</span>, <span class=\"number\">1</span>:<span class=\"number\">0.5</span>]         <span class=\"comment\"># 2个连接</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"添加自环后：\"><a href=\"#添加自环后：\" class=\"headerlink\" title=\"添加自环后：\"></a>添加自环后：</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">节点<span class=\"number\">0</span>: [<span class=\"number\">0</span>:<span class=\"number\">1.0</span>, <span class=\"number\">1</span>:<span class=\"number\">0.9</span>, <span class=\"number\">2</span>:<span class=\"number\">0.8</span>, <span class=\"number\">3</span>:<span class=\"number\">0.7</span>]</span><br><span class=\"line\">节点<span class=\"number\">1</span>: [<span class=\"number\">0</span>:<span class=\"number\">0.9</span>, <span class=\"number\">1</span>:<span class=\"number\">1.0</span>, <span class=\"number\">2</span>:<span class=\"number\">0.5</span>, <span class=\"number\">4</span>:<span class=\"number\">0.4</span>]</span><br><span class=\"line\">节点<span class=\"number\">2</span>: [<span class=\"number\">0</span>:<span class=\"number\">0.8</span>, <span class=\"number\">1</span>:<span class=\"number\">0.5</span>, <span class=\"number\">2</span>:<span class=\"number\">1.0</span>]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"最终三个数组的内容：\"><a href=\"#最终三个数组的内容：\" class=\"headerlink\" title=\"最终三个数组的内容：\"></a>最终三个数组的内容：</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">r = [<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">2</span>]    <span class=\"comment\"># 源节点：0,0,1,1,2,2</span></span><br><span class=\"line\">c = [<span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>]    <span class=\"comment\"># 目标节点：0,1,1,0,2,0  </span></span><br><span class=\"line\">v = [<span class=\"number\">1.0</span>, <span class=\"number\">0.9</span>, <span class=\"number\">1.0</span>, <span class=\"number\">0.9</span>, <span class=\"number\">1.0</span>, <span class=\"number\">0.8</span>]  <span class=\"comment\"># 权重</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> trange(ppi_net_mat.shape[<span class=\"number\">0</span>]):</span><br><span class=\"line\">        <span class=\"comment\"># 遍历每个蛋白质，按亲密程度排序，只取前top个，减少很多弱连接（噪声）</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> v_, c_ <span class=\"keyword\">in</span> <span class=\"built_in\">sorted</span>(<span class=\"built_in\">zip</span>(ppi_net_mat[i].data, ppi_net_mat[i].indices), reverse=<span class=\"literal\">True</span>)[:top]:</span><br><span class=\"line\">            r.append(i) <span class=\"comment\"># 源节点索引</span></span><br><span class=\"line\">            c.append(c_) <span class=\"comment\"># 目标节点索引</span></span><br><span class=\"line\">            v.append(v_) <span class=\"comment\"># 权重值</span></span><br><span class=\"line\">    <span class=\"comment\">#用新数据创建新的网络</span></span><br><span class=\"line\">    <span class=\"comment\">#转置（.T）后，每个节点从关注它的邻居接收消息，节点可以聚合来自多个邻居的信息</span></span><br><span class=\"line\">    <span class=\"comment\">#然后再标准化一下</span></span><br><span class=\"line\">    ppi_net_mat = get_norm_net_mat(ssp.csc_matrix((v, (r, c)), shape=ppi_net_mat.shape).T)</span><br><span class=\"line\">    logger.info(<span class=\"string\">F&#x27;<span class=\"subst\">&#123;ppi_net_mat.shape&#125;</span> <span class=\"subst\">&#123;ppi_net_mat.nnz&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 构建的CSC矩阵：</span></span><br><span class=\"line\">[[<span class=\"number\">1.0</span>, <span class=\"number\">0.9</span>, <span class=\"number\">0.0</span>],</span><br><span class=\"line\"> [<span class=\"number\">0.9</span>, <span class=\"number\">1.0</span>, <span class=\"number\">0.0</span>],</span><br><span class=\"line\"> [<span class=\"number\">0.8</span>, <span class=\"number\">0.0</span>, <span class=\"number\">1.0</span>]]</span><br><span class=\"line\"><span class=\"comment\"># 转置后的矩阵：</span></span><br><span class=\"line\">[[<span class=\"number\">1.0</span>, <span class=\"number\">0.9</span>, <span class=\"number\">0.8</span>],</span><br><span class=\"line\"> [<span class=\"number\">0.9</span>, <span class=\"number\">1.0</span>, <span class=\"number\">0.0</span>],</span><br><span class=\"line\"> [<span class=\"number\">0.0</span>, <span class=\"number\">0.0</span>, <span class=\"number\">1.0</span>]]</span><br><span class=\"line\"> <span class=\"comment\">#归一化后矩阵 = </span></span><br><span class=\"line\">[[<span class=\"number\">0.58</span>, <span class=\"number\">0.52</span>, <span class=\"number\">0.46</span>],</span><br><span class=\"line\"> [<span class=\"number\">0.52</span>, <span class=\"number\">0.58</span>, <span class=\"number\">0.00</span>],</span><br><span class=\"line\"> [<span class=\"number\">0.00</span>, <span class=\"number\">0.00</span>, <span class=\"number\">0.58</span>]]</span><br></pre></td></tr></table></figure>\n\n<p><code>shape=ppi_net_mat.shape</code> 保持与原矩阵相同的维度。筛选时构建的关系：节点视角的”我关注谁”，表示”节点关注这些重要的邻居”。但GNN消息传递需要：邻居视角的”谁关注我”，表示后续需要从邻居节点来获取、聚合信息，所以在这里进行转置。GNN需要的是”入边”关系，而不是”出边”关系。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#转化成COO格式的稀疏矩阵</span></span><br><span class=\"line\">ppi_net_mat_coo = ssp.coo_matrix(ppi_net_mat)</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/12eda/Pictures@main/image-20251104193035512.png\" alt=\"image-20251104193035512\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nx_graph = nx.DiGraph()</span><br><span class=\"line\"><span class=\"comment\">#NetworkX格式：便于图操作和调试</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> u, v, d <span class=\"keyword\">in</span> tqdm(<span class=\"built_in\">zip</span>(ppi_net_mat_coo.row, ppi_net_mat_coo.col, ppi_net_mat_coo.data),</span><br><span class=\"line\">                    total=ppi_net_mat_coo.nnz, desc=<span class=\"string\">&#x27;PPI&#x27;</span>):</span><br><span class=\"line\">    nx_graph.add_edge(u, v, ppi=d)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#图神经网络专用，高效计算</span></span><br><span class=\"line\">dgl_graph = dgl.from_networkx(nx_graph, edge_attrs=[<span class=\"string\">&#x27;ppi&#x27;</span>])<span class=\"comment\">#将nx_graph边的 ppi 属性转换为DGL边的特征</span></span><br><span class=\"line\"><span class=\"comment\"># 确保没有蛋白质被超过top个其他蛋白质关注</span></span><br><span class=\"line\"><span class=\"keyword\">assert</span> dgl_graph.in_degrees().<span class=\"built_in\">max</span>() &lt;= top</span><br><span class=\"line\">dgl.data.utils.save_graphs(dgl_graph_path, dgl_graph)</span><br></pre></td></tr></table></figure>","feature":true,"text":"​ 这是一个蛋白质相互作用网络(PPI)的图数据处理脚本，它通过加载稀疏矩阵格式的PPI网络数据，为每个蛋白质节点保留权重最高的前top个连接边，添加自环并进行...","permalink":"/post/DFMB-preprocessing","photos":[],"count_time":{"symbolsCount":"3k","symbolsTime":"3 mins."},"categories":[{"name":"DeepFMB","slug":"DeepFMB","count":6,"path":"api/categories/DeepFMB.json"}],"tags":[{"name":"项目","slug":"项目","count":6,"path":"api/tags/项目.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8E%9F%E5%A7%8BPPI%E7%BD%91%E7%BB%9C%EF%BC%9A\"><span class=\"toc-text\">原始PPI网络：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B7%BB%E5%8A%A0%E8%87%AA%E7%8E%AF%E5%90%8E%EF%BC%9A\"><span class=\"toc-text\">添加自环后：</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9C%80%E7%BB%88%E4%B8%89%E4%B8%AA%E6%95%B0%E7%BB%84%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%9A\"><span class=\"toc-text\">最终三个数组的内容：</span></a></li></ol>","author":{"name":"Qushubiao","slug":"blog-author","avatar":"https://s2.loli.net/2025/10/18/RHJMI8AE6TVS21l.jpg","link":"/","description":"做难事必有所得","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"DFMB-data_utils","uid":"b1dc64af12759d9df8f8c0d6049f8b08","slug":"DFMB-data_utils","date":"2025-11-07T16:00:00.000Z","updated":"2025-11-12T12:51:22.019Z","comments":true,"path":"api/articles/DFMB-data_utils.json","keywords":null,"cover":[],"text":"涉及以下函数的实现： 12__all__ = ['get_pid_list', 'get_go_list', 'get_pid_go', 'get_pid_go...","permalink":"/post/DFMB-data_utils","photos":[],"count_time":{"symbolsCount":"6.2k","symbolsTime":"6 mins."},"categories":[{"name":"DeepFMB","slug":"DeepFMB","count":6,"path":"api/categories/DeepFMB.json"}],"tags":[{"name":"项目","slug":"项目","count":6,"path":"api/tags/项目.json"}],"author":{"name":"Qushubiao","slug":"blog-author","avatar":"https://s2.loli.net/2025/10/18/RHJMI8AE6TVS21l.jpg","link":"/","description":"做难事必有所得","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"DFMB-generate_data","uid":"80bdf4334493e2cc51bf0382bdaa975b","slug":"DFMB-generate_data","date":"2025-10-29T16:00:00.000Z","updated":"2025-11-04T14:15:35.888Z","comments":true,"path":"api/articles/DFMB-generate_data.json","keywords":null,"cover":null,"text":"以下为实验代码： 主要用于解析基因本体(GO)数据库的层级结构，并针对蛋白质的三个功能类别（生物过程、分子功能、细胞组分）分别处理训练集和测试集数据，生成包含蛋...","permalink":"/post/DFMB-generate_data","photos":[],"count_time":{"symbolsCount":"12k","symbolsTime":"11 mins."},"categories":[{"name":"DeepFMB","slug":"DeepFMB","count":6,"path":"api/categories/DeepFMB.json"}],"tags":[{"name":"项目","slug":"项目","count":6,"path":"api/tags/项目.json"}],"author":{"name":"Qushubiao","slug":"blog-author","avatar":"https://s2.loli.net/2025/10/18/RHJMI8AE6TVS21l.jpg","link":"/","description":"做难事必有所得","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}